# 知识库名称映射显示功能

## 功能概述

为了解决用户输入的原始知识库名称（如"舒一笑不秀头个人信息"）与系统内部编码后的名称（如"kb_dd65ff91_kb"）之间的映射关系不清晰的问题，新增了名称映射显示功能。

## 新增功能

### 1. 上传成功提示优化

上传文本或文件成功后，会显示详细的映射信息：

```
✓ 成功上传 6 个文档片段
总文档数: 6

💡 名称映射
原始名称: 舒一笑不秀头个人信息
编码名称: kb_dd65ff91_kb
```

### 2. 知识库信息增强

在"知识库信息"卡片中，现在会显示：
- 集合名称（编码后）
- 原始名称（如果有）
- 文档数量
- 检索模式
- 名称映射说明框（如果名称被编码）

### 3. 名称映射表

新增"名称映射表"卡片，显示所有知识库的映射关系：
- 📝 原始名称（绿色显示）
- ➜ 编码名称（灰色等宽字体）
- 文档数量
- 支持滚动查看多个映射

### 4. 自动刷新

- 上传成功后自动刷新映射表
- 所有知识库名称输入框自动同步

## API 变更

### 新增接口

#### GET `/api/rag/mappings`

获取所有知识库名称映射关系。

**响应示例：**
```json
{
  "mappings": [
    {
      "original_name": "舒一笑不秀头个人信息",
      "normalized_name": "kb_dd65ff91_kb",
      "document_count": 6
    }
  ],
  "total_count": 1
}
```

### 修改的接口

#### GET `/api/rag/info/{collection_name}`

返回信息中增加了映射相关字段。

**新增响应字段：**
```json
{
  "collection_name": "kb_dd65ff91_kb",
  "original_name": "舒一笑不秀头个人信息",
  "is_normalized": true,
  "document_count": 6,
  "retrieval_mode": "hybrid"
}
```

#### POST `/api/rag/upload/texts`
#### POST `/api/rag/upload/file`
#### POST `/api/rag/upload/directory`

返回信息中增加了 `original_name` 字段。

**新增响应字段：**
```json
{
  "message": "文本上传成功",
  "collection_name": "kb_dd65ff91_kb",
  "original_name": "舒一笑不秀头个人信息",
  "chunks_added": 6,
  "total_documents": 6
}
```

## 使用方法

### 查看映射关系

1. 打开 http://localhost:8000
2. 切换到"知识库管理"标签页
3. 找到"名称映射表"卡片
4. 点击"加载映射关系"按钮

### 上传时查看映射

1. 在"上传文本"或"上传文件"区域输入知识库名称
2. 上传文档
3. 成功提示中会显示原始名称和编码后名称的对应关系

### 查询知识库信息

1. 在"知识库信息"区域输入知识库名称
2. 点击"刷新信息"
3. 如果名称被编码，会显示映射关系说明框

## 技术实现

### 后端实现

1. **映射存储**：使用全局字典 `collection_name_mapping` 存储映射关系
2. **规范化函数**：`normalize_collection_name()` 负责将原始名称转换为合法名称
3. **反向查找**：在 `get_rag_info()` 中实现了反向查找原始名称的功能

### 前端实现

1. **同步函数**：`syncCollectionName()` 同步所有输入框
2. **映射显示**：`loadMappings()` 加载并显示映射表
3. **自动刷新**：上传成功后自动调用 `loadMappings()`

## 界面展示

### 映射表样式

```
共 1 个映射
┌─────────────────────────────────────────────┐
│ 📝 舒一笑不秀头个人信息                    6 个文档 │
│ ➜ kb_dd65ff91_kb                           │
├─────────────────────────────────────────────┤
│ 📝 测试知识库                              12 个文档│
│ ➜ kb_a1b2c3d4                              │
└─────────────────────────────────────────────┘
```

### 上传成功提示

使用绿色提示框，包含：
- ✓ 成功标记
- 上传的文档片段数量
- 总文档数
- 💡 名称映射说明（如果名称被编码）

## 名称规范化规则

ChromaDB 要求集合名称：
- 长度：3-512 个字符
- 字符集：只能包含 `[a-zA-Z0-9._-]`
- 开头/结尾：必须是 `[a-zA-Z0-9]`

系统会自动将不符合规则的名称转换为合法格式：
- 提取可用字符作为前缀（提高可读性）
- 添加 MD5 哈希值（确保唯一性）
- 格式：`{prefix}_{hash}` 例如 `kb_dd65ff91`

## 文件变更

- `src/shuyixiao_agent/web_app.py`
  - 新增 `/api/rag/mappings` 接口
  - 修改 `get_rag_info()` 增加映射信息
  - 修改上传接口返回 `original_name`

- `src/shuyixiao_agent/static/index.html`
  - 新增"名称映射表"卡片
  - 新增 `loadMappings()` 函数
  - 优化上传成功提示显示
  - 优化知识库信息显示

## 注意事项

1. 映射关系存储在内存中，重启服务器后会丢失（但不影响数据，只是需要重新建立映射）
2. 同一个原始名称总是映射到同一个编码名称（使用 MD5 保证一致性）
3. 建议使用英文或数字作为知识库名称，避免不必要的编码转换

## 未来改进

1. 将映射关系持久化到数据库
2. 支持编辑/删除映射关系
3. 支持批量重命名知识库
4. 添加映射关系导出/导入功能

