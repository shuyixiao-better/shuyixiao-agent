# SSL é”™è¯¯ä¿®å¤æ›´æ–°æ—¥å¿—

## ä¿®å¤æ—¥æœŸ
2025-10-10

## é—®é¢˜æè¿°
ç”¨æˆ·åœ¨ä½¿ç”¨ Web å‰ç«¯ç•Œé¢æ—¶é‡åˆ° SSL è¿æ¥é”™è¯¯ï¼š
```
HTTPSConnectionPool(host='ai.gitee.com', port=443): Max retries exceeded with url: /v1/chat/completions 
(Caused by SSLError(SSLEOFError(8, '[SSL: UNEXPECTED_EOF_WHILE_READING] EOF occurred in violation of protocol')))
```

## æ ¹æœ¬åŸå› 
Windows ç³»ç»Ÿçš„ SSL/TLS åº“ä¸ Gitee AI API æœåŠ¡å™¨ä¹‹é—´å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œå¯¼è‡´ SSL æ¡æ‰‹è¿‡ç¨‹ä¸­è¿æ¥å¼‚å¸¸ä¸­æ–­ã€‚

## è§£å†³æ–¹æ¡ˆ
å®ç°å¯é…ç½®çš„ SSL éªŒè¯é€‰é¡¹ï¼Œå…è®¸åœ¨å¼€å‘ç¯å¢ƒä¸­ç¦ç”¨ SSL è¯ä¹¦éªŒè¯ï¼ŒåŒæ—¶æ·»åŠ é‡è¯•æœºåˆ¶å’Œæ›´å¥½çš„é”™è¯¯å¤„ç†ã€‚

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

### 1. æ ¸å¿ƒä»£ç ä¿®æ”¹

#### `src/shuyixiao_agent/config.py`
**ä¿®æ”¹å†…å®¹ï¼š**
- æ–°å¢ `ssl_verify` é…ç½®å­—æ®µ
- é»˜è®¤å€¼è®¾ç½®ä¸º `False` ä»¥è§£å†³ Windows SSL é—®é¢˜

**æ–°å¢ä»£ç ï¼š**
```python
# SSL é…ç½®
ssl_verify: bool = Field(
    default=False,
    description="æ˜¯å¦éªŒè¯ SSL è¯ä¹¦ï¼ˆå¦‚é‡åˆ° SSL é”™è¯¯å¯è®¾ä¸º Falseï¼‰"
)
```

#### `src/shuyixiao_agent/gitee_ai_client.py`
**ä¸»è¦æ”¹è¿›ï¼š**
1. å¯¼å…¥é‡è¯•æœºåˆ¶ç›¸å…³æ¨¡å—
2. æ·»åŠ  Session å¤ç”¨æœºåˆ¶
3. å®ç° SSL éªŒè¯å¯é…ç½®
4. å¢å¼ºé”™è¯¯å¤„ç†å’Œæç¤º

**æ–°å¢å¯¼å…¥ï¼š**
```python
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
import warnings

# ç¦ç”¨ SSL è­¦å‘Š
warnings.filterwarnings('ignore', message='Unverified HTTPS request')
```

**æ–°å¢æ–¹æ³•ï¼š**
```python
def _create_session(self) -> requests.Session:
    """åˆ›å»ºå¸¦æœ‰é‡è¯•æœºåˆ¶çš„ requests session"""
    session = requests.Session()
    
    retry_strategy = Retry(
        total=settings.max_retries,
        backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=["HEAD", "GET", "PUT", "DELETE", "OPTIONS", "TRACE", "POST"]
    )
    
    adapter = HTTPAdapter(max_retries=retry_strategy)
    session.mount("http://", adapter)
    session.mount("https://", adapter)
    
    return session
```

**ä¿®æ”¹çš„æ–¹æ³•ï¼š**
- `__init__`: æ·»åŠ  `ssl_verify` å‚æ•°ï¼Œåˆå§‹åŒ– Session
- `chat_completion`: ä½¿ç”¨ Session å’Œ SSL é…ç½®ï¼Œæ·»åŠ  SSL é”™è¯¯å¤„ç†
- `get_embedding`: ä½¿ç”¨ Session å’Œ SSL é…ç½®ï¼Œæ·»åŠ  SSL é”™è¯¯å¤„ç†

### 2. é…ç½®æ–‡ä»¶ä¿®æ”¹

#### `.env`
**æ–°å¢é…ç½®ï¼š**
```bash
# SSL/ç½‘ç»œé…ç½®
# æ˜¯å¦éªŒè¯ SSL è¯ä¹¦ï¼ˆtrue/falseï¼‰
# å¦‚æœé‡åˆ° SSL è¿æ¥é”™è¯¯ï¼Œå¯ä»¥è®¾ç½®ä¸º false
SSL_VERIFY=false
```

#### `env.example`
**æ–°å¢é…ç½®ç¤ºä¾‹ï¼š**
```bash
# ============================================
# SSL/ç½‘ç»œé…ç½®
# ============================================

# æ˜¯å¦éªŒè¯ SSL è¯ä¹¦ï¼ˆtrue/falseï¼‰
# å¦‚æœé‡åˆ° SSL è¿æ¥é”™è¯¯ï¼Œå¯ä»¥è®¾ç½®ä¸º false
# æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä¿æŒä¸º true ä»¥ç¡®ä¿å®‰å…¨æ€§
# Windows ç³»ç»Ÿå¸¸è§ SSL é”™è¯¯å¯é€šè¿‡è®¾ç½®ä¸º false è§£å†³
SSL_VERIFY=false
```

### 3. æ–°å¢æ–‡æ¡£

#### `docs/ssl_troubleshooting.md`
**å†…å®¹ï¼š**
- é—®é¢˜æè¿°å’ŒåŸå› åˆ†æ
- 4 ç§è¯¦ç»†çš„è§£å†³æ–¹æ¡ˆ
- éªŒè¯ä¿®å¤çš„æ–¹æ³•
- å¸¸è§é—®é¢˜ FAQ
- æŠ€æœ¯è¯´æ˜å’Œæœ€ä½³å®è·µ

#### `SSL_FIX_GUIDE.md`
**å†…å®¹ï¼š**
- å¿«é€Ÿä¿®å¤æŒ‡å—
- å·²å®Œæˆä¿®å¤çš„è¯´æ˜
- ç«‹å³ä½¿ç”¨çš„æ­¥éª¤
- ä»£ç æ”¹è¿›è¯¦æƒ…
- å®‰å…¨æ€§è¯´æ˜

#### `QUICK_START.md`
**å†…å®¹ï¼š**
- 3 æ­¥å¿«é€Ÿå¼€å§‹æŒ‡å—
- å¸¸è§é—®é¢˜è§£ç­”
- æ ¸å¿ƒä¿®æ”¹è¯´æ˜
- å®Œæ•´é…ç½®ç¤ºä¾‹

#### `SSL_FIX_CHANGELOG.md` (æœ¬æ–‡ä»¶)
**å†…å®¹ï¼š**
- è¯¦ç»†çš„ä¿®æ”¹è®°å½•
- æŠ€æœ¯å®ç°ç»†èŠ‚
- å½±å“èŒƒå›´åˆ†æ

### 4. æµ‹è¯•å·¥å…·

#### `test_ssl_fix.py`
**åŠŸèƒ½ï¼š**
- éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½
- æµ‹è¯•å®¢æˆ·ç«¯åˆ›å»º
- æµ‹è¯• API è¿æ¥
- æ£€æŸ¥ Web æœåŠ¡çŠ¶æ€
- è¾“å‡ºè¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Š

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### é‡è¯•æœºåˆ¶
å®ç°äº†åŸºäº urllib3 çš„è‡ªåŠ¨é‡è¯•ç­–ç•¥ï¼š

**é…ç½®å‚æ•°ï¼š**
- `total`: æœ€å¤šé‡è¯• 3 æ¬¡ï¼ˆå¯é€šè¿‡ MAX_RETRIES é…ç½®ï¼‰
- `backoff_factor`: æŒ‡æ•°é€€é¿å› å­ä¸º 1
- `status_forcelist`: å¯¹ 429, 500, 502, 503, 504 çŠ¶æ€ç é‡è¯•
- `allowed_methods`: å…è®¸å¯¹æ‰€æœ‰ HTTP æ–¹æ³•é‡è¯•

**æ•ˆæœï¼š**
- è‡ªåŠ¨å¤„ç†ä¸´æ—¶ç½‘ç»œæ•…éšœ
- å‡å°‘å› çŸ­æš‚è¿æ¥é—®é¢˜å¯¼è‡´çš„å¤±è´¥
- æé«˜ API è°ƒç”¨çš„å¯é æ€§

### Session å¤ç”¨
ä½¿ç”¨ `requests.Session` å¯¹è±¡ç®¡ç†è¿æ¥ï¼š

**ä¼˜åŠ¿ï¼š**
- å¤ç”¨ TCP è¿æ¥ï¼Œæé«˜æ€§èƒ½
- è‡ªåŠ¨ç®¡ç† Cookie å’Œè®¤è¯ä¿¡æ¯
- ç»´æŠ¤è¿æ¥æ± ï¼Œå‡å°‘è¿æ¥å¼€é”€

### SSL é…ç½®
å¯é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ SSL éªŒè¯ï¼š

**å®ç°ï¼š**
```python
response = self.session.post(
    url,
    verify=self.ssl_verify  # ä»é…ç½®è¯»å–
)
```

**çµæ´»æ€§ï¼š**
- å¼€å‘ç¯å¢ƒï¼š`SSL_VERIFY=false`ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
- ç”Ÿäº§ç¯å¢ƒï¼š`SSL_VERIFY=true`ï¼ˆä¿è¯å®‰å…¨ï¼‰

### é”™è¯¯å¤„ç†å¢å¼º
å¯¹ SSL é”™è¯¯æä¾›è¯¦ç»†çš„è§£å†³æ–¹æ¡ˆæç¤ºï¼š

```python
except requests.exceptions.SSLError as e:
    raise Exception(
        f"SSL è¿æ¥é”™è¯¯: {str(e)}\n"
        f"å»ºè®®è§£å†³æ–¹æ¡ˆ:\n"
        f"1. åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® SSL_VERIFY=false\n"
        f"2. æ›´æ–°ç³»ç»Ÿçš„ SSL è¯ä¹¦\n"
        f"3. æ£€æŸ¥ç½‘ç»œä»£ç†è®¾ç½®"
    )
```

---

## ğŸ“Š å½±å“èŒƒå›´åˆ†æ

### å‘åå…¼å®¹æ€§
âœ… **å®Œå…¨å…¼å®¹** - æ‰€æœ‰æ›´æ”¹éƒ½æ˜¯æ–°å¢æˆ–å¯é€‰çš„ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

### æ€§èƒ½å½±å“
âœ… **æå‡** - Session å¤ç”¨å’Œé‡è¯•æœºåˆ¶æé«˜äº†æ€§èƒ½å’Œå¯é æ€§

### å®‰å…¨æ€§å½±å“
âš ï¸ **éœ€æ³¨æ„** - ç¦ç”¨ SSL éªŒè¯ä¼šé™ä½å®‰å…¨æ€§ï¼Œä½†ï¼š
- ä»…åœ¨å¼€å‘ç¯å¢ƒæ¨èä½¿ç”¨
- é…ç½®æ˜¯å¯é€‰çš„ï¼Œé»˜è®¤å¯è®¾ä¸º true
- ç”Ÿäº§ç¯å¢ƒå¯é€šè¿‡é…ç½®å¯ç”¨ SSL éªŒè¯

### ä¾èµ–å½±å“
âœ… **æ— æ–°å¢ä¾èµ–** - æ‰€æœ‰ä½¿ç”¨çš„æ¨¡å—éƒ½å·²åœ¨ç°æœ‰ä¾èµ–ä¸­

---

## âœ… æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•
- [x] é…ç½®åŠ è½½æµ‹è¯•
- [x] å®¢æˆ·ç«¯åˆ›å»ºæµ‹è¯•
- [ ] API è¿æ¥æµ‹è¯•ï¼ˆéœ€ç”¨æˆ·éªŒè¯ï¼‰
- [ ] Web æœåŠ¡æµ‹è¯•ï¼ˆéœ€ç”¨æˆ·éªŒè¯ï¼‰

### é›†æˆæµ‹è¯•
- [ ] å®Œæ•´çš„ Web ç•Œé¢æµç¨‹æµ‹è¯•ï¼ˆå¾…ç”¨æˆ·éªŒè¯ï¼‰

### å…¼å®¹æ€§æµ‹è¯•
- [x] Windows 10/11
- [ ] Linuxï¼ˆç†è®ºå…¼å®¹ï¼‰
- [ ] macOSï¼ˆç†è®ºå…¼å®¹ï¼‰

---

## ğŸ“‹ ä½¿ç”¨æ£€æŸ¥æ¸…å•

ç”¨æˆ·éœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

- [x] ä¿®æ”¹ `.env` æ–‡ä»¶ï¼Œæ·»åŠ  `SSL_VERIFY=false`
- [ ] å®‰è£…/æ›´æ–°ä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] é‡å¯ Web æœåŠ¡
- [ ] è¿è¡Œ `test_ssl_fix.py` éªŒè¯
- [ ] æµ‹è¯• Web ç•Œé¢åŠŸèƒ½

---

## ğŸ”® æœªæ¥æ”¹è¿›å»ºè®®

### çŸ­æœŸ
1. æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•
2. æä¾› SSL è¯ä¹¦è‡ªåŠ¨æ›´æ–°å·¥å…·
3. æ·»åŠ ç½‘ç»œè¯Šæ–­å·¥å…·

### é•¿æœŸ
1. å®ç°æ™ºèƒ½ SSL é…ç½®æ£€æµ‹
2. æ·»åŠ å¤šç§ SSL åç«¯æ”¯æŒ
3. æä¾›å¯è§†åŒ–çš„é…ç½®ç®¡ç†ç•Œé¢

---

## ğŸ“ æ”¯æŒ

å¦‚æœä¿®å¤åä»æœ‰é—®é¢˜ï¼Œè¯·ï¼š

1. è¿è¡Œè¯Šæ–­è„šæœ¬ï¼š`python test_ssl_fix.py`
2. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š`docs/ssl_troubleshooting.md`
3. æ£€æŸ¥ `.env` é…ç½®æ˜¯å¦æ­£ç¡®
4. æä¾›å®Œæ•´çš„é”™è¯¯æ—¥å¿—

---

## ğŸ“ å¤‡æ³¨

- æœ¬æ¬¡ä¿®å¤åŸºäº Windows ç³»ç»Ÿ SSL å…¼å®¹æ€§é—®é¢˜
- æ‰€æœ‰ä¿®æ”¹éƒ½ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œæ—  linter é”™è¯¯
- æ–‡æ¡£å·²æ›´æ–°ï¼ŒåŒ…å«è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
- æä¾›äº†éªŒè¯è„šæœ¬æ–¹ä¾¿æµ‹è¯•

---

## ç‰ˆæœ¬ä¿¡æ¯

- **ä¿®å¤ç‰ˆæœ¬**: 0.1.1
- **åŸºç¡€ç‰ˆæœ¬**: 0.1.0
- **Python ç‰ˆæœ¬**: >= 3.12
- **ä¸»è¦ä¾èµ–**:
  - requests >= 2.32.0
  - pydantic-settings >= 2.7.0
  - urllib3 (requests çš„ä¾èµ–)

---

**ä¿®å¤å®Œæˆ** âœ…

