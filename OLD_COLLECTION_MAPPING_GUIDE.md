# 旧知识库名称映射指南

## 问题说明

在bug修复前创建的知识库（如 `kb_dd65ff91_kb`）没有保存原始中文名称到metadata中，导致页面只能显示编码名称。

## ✅ 解决方案（无需迁移数据）

现在你可以通过配置文件直接指定旧知识库的原始名称，**无需重新创建或迁移数据**。

## 📝 使用方法

### 步骤1: 编辑配置文件

编辑项目根目录下的 `knowledge_base_mappings.json` 文件：

```json
{
  "comment": "旧知识库名称映射配置",
  "description": "用于映射旧的编码名称到原始中文名称，修改后重启服务器生效",
  "mappings": {
    "kb_dd65ff91_kb": "舒一笑个人信息",
    "其他编码名称": "对应的中文名称"
  }
}
```

**如何找到编码名称？**

1. 访问 http://localhost:8001
2. 进入"知识库管理"标签页
3. 点击"刷新列表"查看所有知识库
4. 记下编码名称（如 `kb_dd65ff91_kb`）

### 步骤2: 重启服务器

修改配置文件后，重启服务器使配置生效：

```bash
# 停止当前服务器（Ctrl+C）
# 重新启动
python run_web.py
```

### 步骤3: 验证效果

启动日志中会显示：

```
🔄 正在恢复知识库名称映射关系...
  📄 已加载配置文件: 1 个预定义映射
  ✓ 恢复映射(已知旧数据): '舒一笑个人信息' -> 'kb_dd65ff91_kb'
✅ 已恢复 1 个名称映射关系
```

然后访问页面，应该能看到中文名称 **"舒一笑个人信息"** 而不是 `kb_dd65ff91_kb`。

## 🎯 工作原理

1. **启动时加载配置**: 服务器启动时读取 `knowledge_base_mappings.json`
2. **建立映射关系**: 将配置中的映射加载到内存映射表
3. **API使用映射**: `/api/rag/collections` 接口使用映射表返回原始名称
4. **前端显示中文**: 页面显示配置的中文名称

## 📋 配置文件说明

### 文件位置
```
shuyixiao-agent/
  ├── knowledge_base_mappings.json  ← 配置文件
  ├── run_web.py
  └── src/
```

### 配置格式

```json
{
  "comment": "说明信息（可选）",
  "description": "描述信息（可选）",
  "mappings": {
    "编码名称1": "原始中文名称1",
    "编码名称2": "原始中文名称2"
  }
}
```

**mappings 字段说明**：
- **键（key）**: 编码的collection名称（如 `kb_dd65ff91_kb`）
- **值（value）**: 原始的中文名称（如 `舒一笑个人信息`）

## 🔍 如何找到旧知识库

### 方式1: 使用诊断脚本

```bash
python show_collections.py
```

会显示所有知识库，标记哪些需要映射。

### 方式2: 查看Web界面

1. 启动服务器
2. 访问 http://localhost:8001
3. 进入"知识库管理"
4. 点击"所有知识库" → "刷新列表"
5. 记录显示的编码名称

### 方式3: 查看文档内容推断

```bash
python test_old_kb.py
```

查看知识库中的文档内容，推断原始名称。

## ✨ 优势

✅ **无需迁移数据** - 直接读取旧数据  
✅ **配置即生效** - 修改配置文件，重启即可  
✅ **支持多个库** - 可以配置多个旧知识库的映射  
✅ **向后兼容** - 新知识库自动保存原始名称到metadata  

## 🎨 示例

### 示例1: 单个旧知识库

```json
{
  "mappings": {
    "kb_dd65ff91_kb": "舒一笑个人信息"
  }
}
```

### 示例2: 多个旧知识库

```json
{
  "mappings": {
    "kb_dd65ff91_kb": "舒一笑个人信息",
    "kb_abc12345_kb": "项目文档",
    "kb_def67890_kb": "技术笔记"
  }
}
```

### 示例3: 包含说明

```json
{
  "comment": "旧知识库映射配置",
  "description": "这些是在2024年1月前创建的旧知识库",
  "mappings": {
    "kb_dd65ff91_kb": "舒一笑个人信息",
    "default": "默认知识库"
  }
}
```

## 🔧 故障排除

### 问题1: 配置不生效

**解决方法**:
1. 检查JSON格式是否正确（使用JSON验证工具）
2. 确保文件名是 `knowledge_base_mappings.json`
3. 确保文件位于项目根目录
4. 重启服务器

### 问题2: 中文乱码

**解决方法**:
1. 确保文件编码是 UTF-8
2. 使用支持UTF-8的编辑器（如VS Code）

### 问题3: 找不到配置文件

**启动日志会显示**:
```
⚠️  加载配置文件失败: [Errno 2] No such file or directory
```

**解决方法**:
1. 确认配置文件在正确位置
2. 检查文件名拼写

## 📚 相关文档

- [COLLECTION_MAPPING_FIX.md](COLLECTION_MAPPING_FIX.md) - Bug修复说明
- [KNOWLEDGE_BASE_FIXES_SUMMARY.md](KNOWLEDGE_BASE_FIXES_SUMMARY.md) - 知识库功能总结

## ⚙️ 技术细节

### 加载优先级

服务器按以下优先级查找原始名称：

1. **Collection Metadata** - 新知识库自动保存的原始名称
2. **配置文件映射** - `knowledge_base_mappings.json` 中的配置
3. **Collection名称本身** - 如果都没有，使用编码名称

### 配置加载流程

```
启动服务器
  ↓
尝试加载 knowledge_base_mappings.json
  ↓ (成功)
读取 mappings 字段
  ↓
加载到内存映射表 collection_name_mapping
  ↓
扫描所有Collection
  ↓
优先使用metadata中的original_name
  ↓ (如果没有)
使用配置文件中的映射
  ↓
应用就绪，API返回正确的原始名称
```

## 💡 最佳实践

1. **备份配置文件** - 修改前备份
2. **规范命名** - 使用清晰易懂的中文名称
3. **及时更新** - 发现新的旧知识库及时添加到配置
4. **定期清理** - 删除不再使用的知识库

## 🎉 总结

现在你可以：

✅ **直接使用旧数据** - 无需重新创建知识库  
✅ **显示中文名称** - 通过配置文件指定原始名称  
✅ **快速配置** - 编辑JSON文件，重启即生效  
✅ **完全兼容** - 新旧知识库都能正确显示  

享受你的RAG系统吧！🚀

