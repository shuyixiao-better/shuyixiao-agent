# 数据持久化使用说明

## ✅ 问题已解决

你之前遇到的两个问题已经完全解决：
1. ❌ ~~数据库只读错误~~ → ✅ 自动修复权限
2. ❌ ~~重启后数据丢失~~ → ✅ 数据永久保存

## 🚀 快速开始

### 1. 启动服务器

```bash
# 进入项目目录
cd /Users/shuyixiao/PycharmProjects/shuyixiao-agent

# 启动服务器（自动修复权限）
.venv/bin/python run_web.py
```

**启动成功标志：**
```
🔧 正在初始化数据库...
  ✓ 数据库目录已创建
  ✓ 数据库目录权限已设置: 755
  ✓ 数据库权限修复完成
  ✅ 数据库初始化完成
📊 数据库状态: 存在=True, 可读=True, 可写=True
```

### 2. 访问 Web 界面

打开浏览器访问：http://localhost:8000

### 3. 上传文档

**方式一：上传文本**
1. 切换到"知识库管理"标签页
2. 找到"📝 上传文本"卡片
3. 输入知识库名称（例如：我的知识库）
4. 输入文本内容（每行一个文档）
5. 点击"上传文本"

**方式二：上传文件**
1. 在"📁 上传文件"卡片中
2. 输入文件的绝对路径
3. 点击"上传文件"

### 4. 查看数据

**查看文档列表：**
1. 在"📄 文档浏览器"卡片中
2. 点击"加载文档列表"
3. 可以查看、删除文档

**查看名称映射：**
1. 在"🔗 名称映射表"卡片中
2. 点击"加载映射关系"
3. 查看原始名称和编码名称的对应关系

### 5. RAG 问答

1. 切换到"📚 RAG 问答"标签页
2. 选择知识库名称
3. 输入问题
4. 点击"发送"

## 🎯 核心特性

### ✅ 自动权限修复
- 每次启动自动检查和修复权限
- 无需手动运行修复脚本
- 清理临时文件防止锁定

### ✅ 数据永久保存
- 所有数据保存在 `data/chroma` 目录
- 重启后数据完整保留
- 支持多个知识库并存

### ✅ 友好的名称映射
- 中文名称自动转换为合法名称
- 映射表清晰显示对应关系
- 上传成功时显示实际使用的名称

### ✅ 完整的文档管理
- 列表查看所有文档
- 单个文档详情查看
- 删除不需要的文档

## 📊 验证数据持久化

### 测试步骤

1. **上传测试数据**
   ```
   知识库名称：测试库
   文本内容：
   这是第一条测试数据
   这是第二条测试数据
   ```

2. **查看文档**
   - 在文档浏览器中应该看到 2 个文档

3. **重启服务器**
   ```bash
   # 停止（Ctrl+C 或）
   pkill -f run_web.py
   
   # 重新启动
   .venv/bin/python run_web.py
   ```

4. **再次查看**
   - 刷新浏览器页面
   - 文档应该还在！✅

## 🔍 故障排除

### 情况 1：上传时仍报权限错误

**解决方案：**
```bash
# 手动运行快速修复
bash quick_fix.sh

# 重新启动
.venv/bin/python run_web.py
```

### 情况 2：找不到之前的数据

**可能原因：**
- 知识库名称不匹配（被规范化了）

**解决方案：**
1. 在"名称映射表"中查看实际的集合名称
2. 使用实际名称查询数据

### 情况 3：数据库文件很大

**检查大小：**
```bash
du -sh data/chroma
```

**清理方案：**
- 删除不需要的知识库
- 或者备份后重置

## 💡 最佳实践

### 1. 命名建议
- ✅ 推荐：使用英文或数字（如：`my_docs`、`project2024`）
- ⚠️  可用：中文（会被自动转换）
- ❌ 避免：特殊字符（`!@#$%^&*()`）

### 2. 数据组织
- 按主题创建不同的知识库
- 使用有意义的知识库名称
- 定期查看和清理过时数据

### 3. 定期备份
```bash
# 备份数据库
tar -czf backup_$(date +%Y%m%d).tar.gz data/chroma/
```

### 4. 监控空间
```bash
# 查看数据库大小
du -sh data/chroma

# 查看可用空间
df -h .
```

## 📈 系统状态监控

### 查看数据库健康状态

服务器启动时会显示：
```
📊 数据库状态: 存在=True, 可读=True, 可写=True
📦 数据库大小: 0.57 MB, 文件数: 5
```

### API 健康检查

```bash
curl http://localhost:8000/api/health
```

返回：
```json
{
  "status": "healthy",
  "api_key_configured": true,
  "model": "DeepSeek-V3"
}
```

## 🛠️ 高级功能

### 获取知识库信息

```bash
curl 'http://localhost:8000/api/rag/info/知识库名称'
```

### 列出所有映射关系

```bash
curl http://localhost:8000/api/rag/mappings
```

### 查看文档列表

```bash
curl 'http://localhost:8000/api/rag/documents/知识库名称?limit=10'
```

## 📚 相关文档

- [问题解决总结](PROBLEM_SOLVED_SUMMARY.md) - 技术细节
- [数据库持久化修复](DATABASE_PERSISTENCE_FIX.md) - 完整方案
- [名称映射显示](KNOWLEDGE_BASE_MAPPING_DISPLAY.md) - 映射功能
- [快速开始](QUICK_START.md) - 项目入门

## ❓ 常见问题

**Q: 重启后还需要运行修复脚本吗？**  
A: 不需要！现在每次启动会自动修复。

**Q: 我的数据会丢失吗？**  
A: 不会！数据已经持久化保存在 `data/chroma` 目录。

**Q: 中文知识库名称会有问题吗？**  
A: 没问题！系统会自动转换并显示映射关系。

**Q: 如何完全删除所有数据？**  
A: 运行 `bash reset_database.sh` 或手动删除 `data/chroma` 目录。

**Q: 可以同时运行多个服务器吗？**  
A: 不建议，ChromaDB 不支持多进程写入。

## 🎉 总结

现在你可以：
- ✅ 放心上传文档，不会有权限错误
- ✅ 重启服务器，数据完整保留
- ✅ 使用任何名称，自动处理映射
- ✅ 无需手动维护，自动管理一切

**尽情使用吧！** 🚀

---

**有问题？** 查看 [完整文档](PROBLEM_SOLVED_SUMMARY.md) 或提交 Issue

